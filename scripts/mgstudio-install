#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
mgstudio-install

Install mgstudio as a local symlink into a user-writable bin directory.

Usage:
  scripts/mgstudio-install [--bin-dir <dir>] [--dry-run] [--uninstall]

Options:
  --bin-dir <dir>  Target directory on PATH (default: $XDG_BIN_HOME, else ~/.local/bin)
  --dry-run        Print actions without modifying the filesystem
  --uninstall      Remove the installed symlink
  -h, --help       Show this help
EOF
}

DRY_RUN=0
UNINSTALL=0
BIN_DIR="${XDG_BIN_HOME:-$HOME/.local/bin}"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --bin-dir)
      BIN_DIR="${2:-}"
      shift 2
      ;;
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    --uninstall)
      UNINSTALL=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

if [[ -z "${BIN_DIR}" ]]; then
  echo "Missing value for --bin-dir" >&2
  exit 2
fi

# Resolve this script location, following symlinks, so we can compute repo root.
SOURCE="${BASH_SOURCE[0]}"
while [[ -h "${SOURCE}" ]]; do
  DIR="$(cd -P -- "$(dirname -- "${SOURCE}")" && pwd)"
  SOURCE="$(readlink "${SOURCE}")"
  [[ "${SOURCE}" != /* ]] && SOURCE="${DIR}/${SOURCE}"
done
ROOT="$(cd -P -- "$(dirname -- "${SOURCE}")/.." && pwd)"

TARGET="${BIN_DIR}/mgstudio"
LINK="${ROOT}/mgstudio"

run() {
  if [[ "${DRY_RUN}" -eq 1 ]]; then
    echo "+ $*"
  else
    "$@"
  fi
}

if [[ "${UNINSTALL}" -eq 1 ]]; then
  if [[ -e "${TARGET}" || -L "${TARGET}" ]]; then
    run rm -f "${TARGET}"
    echo "Removed: ${TARGET}"
  else
    echo "Not installed: ${TARGET}"
  fi
  exit 0
fi

run mkdir -p "${BIN_DIR}"
run ln -sfn "${LINK}" "${TARGET}"
echo "Installed: ${TARGET} -> ${LINK}"
echo "Make sure '${BIN_DIR}' is on your PATH."

