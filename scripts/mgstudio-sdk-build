#!/usr/bin/env bash
# Copyright 2025 International Digital Economy Academy
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -euo pipefail

usage() {
  cat <<'EOF'
mgstudio-sdk-build

Build a local darwin-arm64 mgstudio SDK directory.

The SDK layout is:
  <SDK_DIR>/bin/mgstudio
  <SDK_DIR>/lib/libwgpu_native.dylib
  <SDK_DIR>/share/mgstudio/assets/...
  <SDK_DIR>/share/mgstudio/web/mgstudio-runtime-web.js
  <SDK_DIR>/share/mgstudio/manifest.json

Usage:
  scripts/mgstudio-sdk-build [--wgpu-lib <path>] [--out <dir>] [--version <v>] [--no-tar]

Options:
  --wgpu-lib <path>  Path to libwgpu_native.dylib to include in the SDK
                     (default: $HOME/.local/lib/libwgpu_native.dylib)
  --no-fetch-wgpu-lib
                     Do not auto-fetch libwgpu_native when the default path is missing
  --out <dir>        Output directory (default: ./_out/sdk)
  --version <v>      SDK version string (default: git describe --tags --always)
  --no-tar           Do not create a .tar.gz alongside the SDK directory
  -h, --help         Show this help
EOF
}

OUT_DIR="./_out/sdk"
WGPU_LIB="${HOME}/.local/lib/libwgpu_native.dylib"
SDK_VERSION=""
NO_TAR=0
NO_FETCH_WGPU_LIB=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --wgpu-lib)
      WGPU_LIB="${2:-}"
      shift 2
      ;;
    --no-fetch-wgpu-lib)
      NO_FETCH_WGPU_LIB=1
      shift
      ;;
    --out)
      OUT_DIR="${2:-}"
      shift 2
      ;;
    --version)
      SDK_VERSION="${2:-}"
      shift 2
      ;;
    --no-tar)
      NO_TAR=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

# Resolve this script location, following symlinks, so we can compute repo root.
SOURCE="${BASH_SOURCE[0]}"
while [[ -h "${SOURCE}" ]]; do
  DIR="$(cd -P -- "$(dirname -- "${SOURCE}")" && pwd)"
  SOURCE="$(readlink "${SOURCE}")"
  [[ "${SOURCE}" != /* ]] && SOURCE="${DIR}/${SOURCE}"
done
ROOT="$(cd -P -- "$(dirname -- "${SOURCE}")/.." && pwd)"

fetch_wgpu_lib() {
  # We intentionally reuse Milky2018/wgpu_mbt's postadd hook to download a
  # prebuilt libwgpu_native.dylib (with SHA256 verification) into
  # $HOME/.local/lib/.
  local root="$1"
  local native_mod="${root}/mgstudio-runtime/native/moon.mod.json"
  local wgpu_mbt_ver=""

  if [[ ! -f "${native_mod}" ]]; then
    echo "Missing: ${native_mod}" >&2
    return 1
  fi
  if ! command -v python3 >/dev/null 2>&1; then
    echo "python3 is required to auto-fetch libwgpu_native (for parsing moon.mod.json)." >&2
    return 1
  fi

  wgpu_mbt_ver="$(python3 - <<PY
import json
with open("${native_mod}", "r", encoding="utf-8") as f:
  data = json.load(f)
deps = data.get("deps", {})
print(deps.get("Milky2018/wgpu_mbt", ""))
PY
)"
  if [[ -z "${wgpu_mbt_ver}" ]]; then
    echo "Failed to read Milky2018/wgpu_mbt version from: ${native_mod}" >&2
    return 1
  fi

  echo "Fetching libwgpu_native via Milky2018/wgpu_mbt@${wgpu_mbt_ver} ..."
  local tmp
  tmp="$(mktemp -d)"
  (
    cd "${tmp}"
    moon new _mgstudio_wgpu_bootstrap >/dev/null
    cd _mgstudio_wgpu_bootstrap
    moon add "Milky2018/wgpu_mbt@${wgpu_mbt_ver}" >/dev/null
  )
  rm -rf "${tmp}"
}

if [[ ! -f "${WGPU_LIB}" ]]; then
  cat >&2 <<EOF
libwgpu_native not found: ${WGPU_LIB}

Install it first, then re-run mgstudio-sdk-build.

Recommended (uses Milky2018/wgpu_mbt postadd to download a prebuilt dylib):
  moon new _tmp_wgpu && cd _tmp_wgpu
  moon add Milky2018/wgpu_mbt
  ls -la "${HOME}/.local/lib/libwgpu_native.dylib"

Or build wgpu-native yourself and copy the resulting dylib to:
  ${HOME}/.local/lib/libwgpu_native.dylib

You can also pass an explicit path:
  scripts/mgstudio-sdk-build --wgpu-lib /absolute/path/to/libwgpu_native.dylib
EOF
  if [[ "${NO_FETCH_WGPU_LIB}" -eq 1 ]]; then
    exit 2
  fi
  if fetch_wgpu_lib "${ROOT}"; then
    if [[ ! -f "${WGPU_LIB}" ]]; then
      echo "Auto-fetch finished, but still missing: ${WGPU_LIB}" >&2
      exit 2
    fi
    echo "Found libwgpu_native: ${WGPU_LIB}"
  else
    echo "Auto-fetch failed. Re-run with an explicit --wgpu-lib path." >&2
    exit 2
  fi
fi

if [[ -z "${SDK_VERSION}" ]]; then
  SDK_VERSION="$(git -C "${ROOT}" describe --tags --always 2>/dev/null || echo "0.0.0-dev")"
fi

SDK_DIR="${OUT_DIR}/mgstudio-sdk-${SDK_VERSION}-darwin-arm64"
rm -rf "${SDK_DIR}"
mkdir -p "${SDK_DIR}/bin" "${SDK_DIR}/lib" "${SDK_DIR}/share/mgstudio"

echo "Building mgstudio-cli (native release)..."
moon build --release -C "${ROOT}/mgstudio-cli"
CLI_BIN="${ROOT}/mgstudio-cli/_build/native/release/build/main/main.exe"
if [[ ! -x "${CLI_BIN}" ]]; then
  echo "mgstudio-cli binary not found at: ${CLI_BIN}" >&2
  exit 1
fi
cp "${CLI_BIN}" "${SDK_DIR}/bin/mgstudio"
chmod +x "${SDK_DIR}/bin/mgstudio"

echo "Building mgstudio-runtime-web.js..."
OUT_DIR="${SDK_DIR}/share/mgstudio/web" bash "${ROOT}/mgstudio-runtime/web/build.sh"
RUNTIME_JS="${SDK_DIR}/share/mgstudio/web/mgstudio-runtime-web.js"
if [[ ! -f "${RUNTIME_JS}" ]]; then
  echo "Runtime JS bundle not found at: ${RUNTIME_JS}" >&2
  exit 1
fi

echo "Copying engine default assets..."
mkdir -p "${SDK_DIR}/share/mgstudio/assets"
cp -R "${ROOT}/mgstudio-engine/assets/." "${SDK_DIR}/share/mgstudio/assets/"

echo "Copying libwgpu_native..."
cp "${WGPU_LIB}" "${SDK_DIR}/lib/libwgpu_native.dylib"

echo "Copying license texts..."
mkdir -p "${SDK_DIR}/share/mgstudio/licenses"
# Project license (Apache-2.0) lives under mgstudio-engine/ in this repo.
cp "${ROOT}/mgstudio-engine/LICENSE" "${SDK_DIR}/share/mgstudio/licenses/LICENSE"
# Third-party: wgpu-native (Apache-2.0 OR MIT). Keep minimal license texts in repo.
if [[ -f "${ROOT}/third_party/wgpu-native/LICENSE-APACHE" ]]; then
  mkdir -p "${SDK_DIR}/share/mgstudio/licenses/wgpu-native"
  cp "${ROOT}/third_party/wgpu-native/LICENSE-APACHE" "${SDK_DIR}/share/mgstudio/licenses/wgpu-native/LICENSE-APACHE"
  cp "${ROOT}/third_party/wgpu-native/LICENSE-MIT" "${SDK_DIR}/share/mgstudio/licenses/wgpu-native/LICENSE-MIT"
fi
cp "${ROOT}/docs/CREDITS.md" "${SDK_DIR}/share/mgstudio/licenses/CREDITS.md"

echo "Writing manifest..."
GIT_SHA="$(git -C "${ROOT}" rev-parse HEAD 2>/dev/null || echo "")"
BUILD_DATE="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
cat >"${SDK_DIR}/share/mgstudio/manifest.json" <<EOF
{
  "name": "mgstudio-sdk",
  "version": "${SDK_VERSION}",
  "platform": "darwin-arm64",
  "git_sha": "${GIT_SHA}",
  "built_at_utc": "${BUILD_DATE}"
}
EOF

echo "Built SDK directory: ${SDK_DIR}"

if [[ "${NO_TAR}" -eq 0 ]]; then
  mkdir -p "${OUT_DIR}"
  TAR="${OUT_DIR}/mgstudio-sdk-${SDK_VERSION}-darwin-arm64.tar.gz"
  echo "Creating tarball: ${TAR}"
  (cd "${OUT_DIR}" && tar -czf "$(basename "${TAR}")" "$(basename "${SDK_DIR}")")

  # Produce a SHA256SUMS file next to the tarball (common release convention).
  if command -v shasum >/dev/null 2>&1; then
    (cd "${OUT_DIR}" && shasum -a 256 "$(basename "${TAR}")" > SHA256SUMS)
  elif command -v sha256sum >/dev/null 2>&1; then
    (cd "${OUT_DIR}" && sha256sum "$(basename "${TAR}")" > SHA256SUMS)
  else
    echo "Warning: no sha256 tool found; skipping SHA256SUMS" >&2
  fi
fi
