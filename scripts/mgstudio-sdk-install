#!/usr/bin/env bash
# Copyright 2025 International Digital Economy Academy
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -euo pipefail

usage() {
  cat <<'EOF'
mgstudio-sdk-install

Install an mgstudio SDK directory to a conventional local location:
  $HOME/.local/share/mgstudio/current

Also optionally installs a PATH shim by symlinking:
  $XDG_BIN_HOME/mgstudio  (default: ~/.local/bin/mgstudio)
to:
  <sdkroot>/bin/mgstudio

Usage:
  scripts/mgstudio-sdk-install --from <sdk-dir> [--sdkroot <dir>] [--bin-dir <dir>] [--no-bin-link] [--dry-run]

Options:
  --from <sdk-dir>   Source SDK directory (required). Must contain bin/lib/share.
  --sdkroot <dir>    Install destination (default: $HOME/.local/share/mgstudio/current)
  --bin-dir <dir>    Target directory on PATH (default: $XDG_BIN_HOME, else ~/.local/bin)
  --no-bin-link      Do not create/update the mgstudio symlink in --bin-dir
  --dry-run          Print actions without modifying the filesystem
  -h, --help         Show this help
EOF
}

FROM=""
SDKROOT="${HOME}/.local/share/mgstudio/current"
BIN_DIR="${XDG_BIN_HOME:-$HOME/.local/bin}"
NO_BIN_LINK=0
DRY_RUN=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --from)
      FROM="${2:-}"
      shift 2
      ;;
    --sdkroot)
      SDKROOT="${2:-}"
      shift 2
      ;;
    --bin-dir)
      BIN_DIR="${2:-}"
      shift 2
      ;;
    --no-bin-link)
      NO_BIN_LINK=1
      shift
      ;;
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

if [[ -z "${FROM}" ]]; then
  echo "Missing required option: --from <sdk-dir>" >&2
  exit 2
fi

if [[ ! -d "${FROM}" ]]; then
  echo "Directory not found: --from ${FROM}" >&2
  exit 2
fi

require_dir() {
  local p="$1"
  if [[ ! -d "${p}" ]]; then
    echo "Invalid SDK (missing directory): ${p}" >&2
    exit 2
  fi
}

require_dir "${FROM}/bin"
require_dir "${FROM}/lib"
require_dir "${FROM}/share"
if [[ ! -x "${FROM}/bin/mgstudio" ]]; then
  echo "Invalid SDK (missing executable): ${FROM}/bin/mgstudio" >&2
  exit 2
fi
if [[ ! -f "${FROM}/share/mgstudio/web/mgstudio-runtime-web.js" ]]; then
  echo "Invalid SDK (missing web runtime): ${FROM}/share/mgstudio/web/mgstudio-runtime-web.js" >&2
  exit 2
fi

run() {
  if [[ "${DRY_RUN}" -eq 1 ]]; then
    echo "+ $*"
  else
    "$@"
  fi
}

mkdir_p() {
  run mkdir -p "$1"
}

rm_rf() {
  if [[ -e "$1" || -L "$1" ]]; then
    run rm -rf "$1"
  fi
}

echo "Installing SDK:"
echo "  from:    ${FROM}"
echo "  to:      ${SDKROOT}"
echo "  bin-dir: ${BIN_DIR} (link=${NO_BIN_LINK})"

BASE_DIR="$(dirname -- "${SDKROOT}")"
mkdir_p "${BASE_DIR}"

TMP="${BASE_DIR}/.tmp.mgstudio-sdk.$$"
rm_rf "${TMP}"
mkdir_p "${TMP}"

# Copy into a temp dir first, then swap, to avoid partially-installed states.
run cp -R "${FROM}/." "${TMP}/"

rm_rf "${SDKROOT}"
run mv "${TMP}" "${SDKROOT}"

echo "Installed SDK root: ${SDKROOT}"

if [[ "${NO_BIN_LINK}" -eq 0 ]]; then
  mkdir_p "${BIN_DIR}"
  run ln -sfn "${SDKROOT}/bin/mgstudio" "${BIN_DIR}/mgstudio"
  echo "Installed: ${BIN_DIR}/mgstudio -> ${SDKROOT}/bin/mgstudio"
  echo "Make sure '${BIN_DIR}' is on your PATH."
fi

