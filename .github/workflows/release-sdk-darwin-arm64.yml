name: release-sdk-darwin-arm64

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      sdk_version:
        description: "SDK version string (defaults to the release tag)"
        required: false
        type: string
      wgpu_native_tag:
        description: "wgpu-native release tag to download libwgpu_native from (e.g. v27.0.4.0)"
        required: false
        default: "v27.0.4.0"
        type: string

permissions:
  contents: write

jobs:
  build-and-upload:
    name: Build & Upload SDK (darwin-arm64)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MoonBit
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.moon/bin:$PATH"
          moon version

      - name: Download wgpu-native (libwgpu_native.dylib)
        shell: bash
        env:
          WGPU_NATIVE_TAG: ${{ inputs.wgpu_native_tag }}
        run: |
          set -euo pipefail
          # NOTE: `inputs.*` are only available for workflow_dispatch. For release builds
          # we use a fixed default tag that is known to ship the darwin-arm64 dylib.
          tag="${WGPU_NATIVE_TAG:-v27.0.4.0}"

          tmp="${RUNNER_TEMP}/wgpu-native"
          rm -rf "${tmp}"
          mkdir -p "${tmp}"

          zip="wgpu-macos-aarch64-release.zip"
          url="https://github.com/gfx-rs/wgpu-native/releases/download/${tag}/${zip}"
          echo "Downloading: ${url}"
          curl -fL -o "${tmp}/${zip}" "${url}"
          unzip -q "${tmp}/${zip}" -d "${tmp}/unpacked"

          if [[ ! -f "${tmp}/unpacked/lib/libwgpu_native.dylib" ]]; then
            echo "libwgpu_native.dylib not found in downloaded archive" >&2
            find "${tmp}/unpacked" -maxdepth 3 -type f | head -n 200 >&2 || true
            exit 1
          fi

          echo "WGPU_NATIVE_LIB=${tmp}/unpacked/lib/libwgpu_native.dylib" >> "$GITHUB_ENV"

      - name: Build SDK directory + tarball
        shell: bash
        env:
          # Prefer the release tag name when running on release events.
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          INPUT_SDK_VERSION: ${{ inputs.sdk_version }}
        run: |
          set -euo pipefail
          raw="${INPUT_SDK_VERSION:-${RELEASE_TAG}}"
          if [[ -z "${raw}" ]]; then
            echo "Unable to determine SDK version (missing release tag and sdk_version input)" >&2
            exit 1
          fi

          # Release tags are usually `vX.Y.Z`, but we want filenames to be `X.Y.Z`.
          version="${raw#v}"

          out="${RUNNER_TEMP}/sdk-out"
          rm -rf "${out}"
          mkdir -p "${out}"

          sdk_dir="${out}/mgstudio-sdk-${version}-darwin-arm64"
          rm -rf "${sdk_dir}"
          mkdir -p "${sdk_dir}/bin" "${sdk_dir}/lib" "${sdk_dir}/share/mgstudio"

          echo "Building mgstudio-cli (native release)..."
          moon build --release -C "./mgstudio-cli"
          cli_bin="./mgstudio-cli/_build/native/release/build/main/main.exe"
          test -x "${cli_bin}"
          cp "${cli_bin}" "${sdk_dir}/bin/mgstudio"
          chmod +x "${sdk_dir}/bin/mgstudio"

          echo "Building mgstudio-runtime-web.js..."
          OUT_DIR="${sdk_dir}/share/mgstudio/web" ./mgstudio-runtime/web/build.sh
          test -f "${sdk_dir}/share/mgstudio/web/mgstudio-runtime-web.js"

          echo "Copying engine default assets..."
          mkdir -p "${sdk_dir}/share/mgstudio/assets"
          cp -R "./mgstudio-engine/assets/." "${sdk_dir}/share/mgstudio/assets/"

          echo "Copying libwgpu_native..."
          cp "${WGPU_NATIVE_LIB}" "${sdk_dir}/lib/libwgpu_native.dylib"

          echo "Copying license texts..."
          mkdir -p "${sdk_dir}/share/mgstudio/licenses"
          cp "./mgstudio-engine/LICENSE" "${sdk_dir}/share/mgstudio/licenses/LICENSE"
          if [[ -f "./third_party/wgpu-native/LICENSE-APACHE" ]]; then
            mkdir -p "${sdk_dir}/share/mgstudio/licenses/wgpu-native"
            cp "./third_party/wgpu-native/LICENSE-APACHE" "${sdk_dir}/share/mgstudio/licenses/wgpu-native/LICENSE-APACHE"
            cp "./third_party/wgpu-native/LICENSE-MIT" "${sdk_dir}/share/mgstudio/licenses/wgpu-native/LICENSE-MIT"
          fi
          if [[ -f "./docs/CREDITS.md" ]]; then
            cp "./docs/CREDITS.md" "${sdk_dir}/share/mgstudio/licenses/CREDITS.md"
          fi

          echo "Writing manifest..."
          git_sha="$(git rev-parse HEAD 2>/dev/null || echo "")"
          build_date="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          cat >"${sdk_dir}/share/mgstudio/manifest.json" <<EOF
          {
            "name": "mgstudio-sdk",
            "version": "${version}",
            "platform": "darwin-arm64",
            "git_sha": "${git_sha}",
            "build_date": "${build_date}"
          }
          EOF

          echo "Packing tarball..."
          tarball="${out}/mgstudio-sdk-${version}-darwin-arm64.tar.gz"
          (cd "${out}" && tar -czf "${tarball}" "mgstudio-sdk-${version}-darwin-arm64")
          test -f "${tarball}"

          echo "Writing SHA256SUMS..."
          (cd "${out}" && shasum -a 256 "$(basename "${tarball}")" > SHA256SUMS)
          test -f "${out}/SHA256SUMS"

          echo "SDK_OUT=${out}" >> "$GITHUB_ENV"
          echo "SDK_TAR=${out}/mgstudio-sdk-${version}-darwin-arm64.tar.gz" >> "$GITHUB_ENV"
          echo "SDK_SHA=${out}/SHA256SUMS" >> "$GITHUB_ENV"

          test -f "${out}/mgstudio-sdk-${version}-darwin-arm64.tar.gz"
          test -f "${out}/SHA256SUMS"

      - name: Upload release assets
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.SDK_TAR }}
            ${{ env.SDK_SHA }}
            mgstudio-install.sh

      - name: Upload workflow artifacts
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: mgstudio-sdk-darwin-arm64
          path: |
            ${{ env.SDK_TAR }}
            ${{ env.SDK_SHA }}
